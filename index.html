<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personalized Weight Loss Kitchen</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font import and application */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue/gray background */
            line-height: 1.6;
        }
        .section-header {
            border-left: 5px solid #2563eb; /* Tailwind blue-600 */
        }
        .recipe-card {
            background-color: #ffffff;
            transition: transform 0.2s;
            border: 1px solid #e2e8f0;
        }
        .recipe-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Style for the Goal cards */
        .goal-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        .kcal-badge { background-color: #fee2e2; color: #ef4444; } /* Red */
        .protein-badge { background-color: #d1fae5; color: #10b981; } /* Green */
        .focus-badge { background-color: #e0f2fe; color: #3b82f6; } /* Blue */
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Header and Introduction -->
    <header class="text-center mb-10 p-6 bg-white rounded-xl shadow-2xl border-b-4 border-blue-600">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-2">My Personalized Weight Loss Kitchen</h1>
        <p class="text-xl text-blue-600 font-medium">Goal: Lose 20 kg in 6 months supported by 2 hours of brisk walking daily.</p>
    </header>

    <!-- Personalized Goal Summary (NEW) -->
    <section class="mb-12">
        <h2 class="text-2xl font-bold section-header pl-3 py-1 mb-6 text-gray-700">üìà My Daily Targets</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <div class="goal-card border-b-4 border-red-500">
                <p class="text-xs font-semibold uppercase text-red-500 mb-1">Calorie Target (Deficit)</p>
                <p class="text-4xl font-extrabold text-gray-800">2,250</p>
                <p class="text-sm text-gray-500">kcal/day</p>
            </div>

            <div class="goal-card border-b-4 border-green-500">
                <p class="text-xs font-semibold uppercase text-green-500 mb-1">Minimum Protein</p>
                <p class="text-4xl font-extrabold text-gray-800">185</p>
                <p class="text-sm text-gray-500">grams/day</p>
            </div>

            <div class="goal-card border-b-4 border-blue-500">
                <p class="text-xs font-semibold uppercase text-blue-500 mb-1">Key Focus</p>
                <p class="text-xl font-extrabold text-gray-800 mt-2">S. Indian Staples</p>
                <p class="text-sm text-gray-500">Lentils, Soya, Eggs, **Leafy Greens**</p>
            </div>

        </div>
    </section>

    <!-- Image Analysis Section (UNCHANGED) -->
    <section class="mb-12 bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-2xl font-bold section-header pl-3 py-1 mb-6 text-gray-700">üì∏ Analyze Your Meal (AI Vision)</h2>
        <p class="text-sm text-gray-500 mb-4">Take a photo of your cooked meal using the camera to get an estimated breakdown of calories and protein.</p>
        
        <input type="file" id="meal-image-input" accept="image/*" capture="environment" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-4">
        
        <div id="loading-indicator" class="hidden text-center p-4 bg-blue-50 text-blue-700 rounded-lg">
            <svg class="animate-spin h-5 w-5 mr-3 inline-block" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            Analyzing image... This may take a moment.
        </div>

        <div id="analysis-result" class="mt-4 p-4 border border-gray-200 rounded-lg bg-gray-50 hidden">
            <h3 class="text-lg font-bold text-gray-800 mb-2">AI Estimated Nutrition:</h3>
            <pre id="analysis-output" class="whitespace-pre-wrap text-sm text-gray-700"></pre>
        </div>

        <div id="analysis-error" class="mt-4 p-4 border border-red-200 rounded-lg bg-red-50 text-red-700 hidden">
            Error during analysis. Please try a different image.
        </div>
    </section>

    <!-- Search Bar Section (UNCHANGED) -->
    <section class="mb-12 bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-2xl font-bold section-header pl-3 py-1 mb-6 text-gray-700">üîç Find Your Recipe</h2>
        <div class="relative">
            <input 
                type="text" 
                id="recipe-search" 
                oninput="filterRecipes()" 
                placeholder="Search by ingredient (e.g., egg, soya, dal) or meal type (lunch, snack)..." 
                class="w-full p-4 pl-12 border-2 border-blue-300 rounded-xl text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-md transition duration-150"
            >
            <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>
    </section>

    <!-- Dynamic Recipe List Section -->
    <section class="mb-12">
        <h2 class="text-2xl font-bold section-header pl-3 py-1 mb-6 text-gray-700">üçΩÔ∏è Budget-Friendly High-Protein Recipes</h2>
        <!-- This container will be populated by JavaScript -->
        <div id="recipe-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Recipes will be inserted here -->
        </div>
        <p id="no-results" class="hidden text-center text-xl text-gray-500 mt-12 p-6 bg-yellow-100 border-l-4 border-yellow-500 rounded-lg">
            No recipes found matching your search. Try a different keyword!
        </p>
    </section>

    <!-- Footer Reminder -->
    <footer class="text-center mt-10 p-4 text-gray-500 text-sm">
        <p class="font-bold text-lg">Goal Reminder:</p>
        <p>Maintain your **2,250 kcal** target and hit the **185g protein** mark daily to fuel your 2-hour brisk walk and achieve your 20kg goal!</p>
    </footer>

    <script>
        // Global variables for Firebase configuration (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const apiKey = "" // API key for Gemini API calls
        
        // --- RECIPE DATA ---
        // Nutritional estimates are based on the large portions needed to hit 2250 kcal / 185g protein per day.
        const allRecipes = [
            {
                id: 1,
                title: "High-Protein Soya Masala Veg Rice",
                focus: "Uses 100g Soya Chunks. Primary Lunch source for protein, fiber, and sustained energy.",
                mealType: "Lunch",
                calories: 650, // Updated for 2,250 kcal plan
                protein: 48, // Increased slightly due to vegetables
                tutorialUrl: "https://www.youtube.com/results?search_query=soya+masala+veg+rice+recipe+south+indian+style", 
                tags: ["soya", "rice", "high protein", "lunch", "indian", "vegetable"],
                ingredients: ["**100g Soya Chunks (dry)**", "Rice (Free, controlled portion)", "**Mixed Vegetables (Carrot, Beans, Peas)**", "Onion/Tomato/Budget Veg", "Minimal Oil/Ghee, Masalas"],
                method: [
                    "Soak Soya Chunks, squeeze out water thoroughly.",
                    "Heat minimal oil/ghee, saut√© onion, add spices and paste.",
                    "Add **mixed vegetables** and cook until tender.",
                    "Add Soya Chunks and cook until lightly browned.",
                    "Mix in pre-cooked Rice and cook for 5 min."
                ]
            },
            {
                id: 2,
                title: "Double-Protein Palak/Methi Dal & Egg Curry",
                focus: "2 Eggs + 150g Dal. High-protein Dinner with added leafy greens for recovery and fiber.",
                mealType: "Dinner",
                calories: 550, 
                protein: 52, // Increased slightly due to greens
                tutorialUrl: "https://www.youtube.com/results?search_query=dal+egg+curry+with+spinach+south+indian", 
                tags: ["egg", "dal", "curry", "dinner", "high protein", "indian", "leafy green"],
                ingredients: ["**2-3 Eggs**", "**150g Dal (pre-cooked)**", "**100g Leafy Greens (Palak/Methi)**", "Onion/Tomato/Budget Veg", "Atta for 3 Rotis (Free)", "Minimal Oil/Ghee, Spices"],
                method: [
                    "Boil and peel the eggs.",
                    "Prepare a light curry base, adding **chopped leafy greens** until wilted.",
                    "Add the pre-cooked Dal and simmer.",
                    "Gently place the boiled eggs into the curry. Serve with rotis."
                ]
            },
            {
                id: 3,
                title: "High-Protein Moong Dal Cheela (4 pcs)",
                focus: "Your heavy Post-Walk Breakfast. Uses 100g Dal for maximum protein.",
                mealType: "Breakfast/Post-Walk",
                calories: 450, 
                protein: 35, 
                tutorialUrl: "https://www.youtube.com/results?search_query=moong+dal+cheela+recipe", 
                tags: ["dal", "moong", "breakfast", "snack", "cheela", "vegetarian"],
                ingredients: ["**100g Moong Dal**", "Green Chili, Ginger", "Water", "Minimal Oil/Ghee"],
                method: [
                    "Soak 100g Moong Dal overnight.",
                    "Blend with chili, ginger, and water to a smooth batter.",
                    "Heat a non-stick pan with minimal oil/ghee and spread the batter thinly (make 4 cheelas).",
                    "Cook on both sides until golden. Serve hot."
                ]
            },
            {
                id: 4,
                title: "Raw Chana Dal Sprout Salad (Large)",
                focus: "Perfect high-fiber, zero-oil afternoon snack (5:00 PM).",
                mealType: "Snack",
                calories: 250, 
                protein: 15, 
                tutorialUrl: "https://www.youtube.com/results?search_query=chana+dal+sprout+salad+recipe", 
                tags: ["chana", "dal", "salad", "raw", "snack", "zero oil"],
                ingredients: ["**75g Chana Dal (soaked/sprouted)**", "Chopped Onion, Tomato, Cucumber", "Salt, Pepper, Lemon Juice"],
                method: [
                    "Soak 75g Chana Dal overnight (or use sprouts).",
                    "Drain and mix with chopped fresh vegetables.",
                    "Add salt, pepper, and lemon juice. Mix well and eat."
                ]
            },
            {
                id: 5,
                title: "High-Fiber Veg Khichdi (Large Serving)",
                focus: "One-pot meal for high fiber and balanced nutrition.",
                mealType: "Lunch/Dinner",
                calories: 600, 
                protein: 40, 
                tutorialUrl: "https://www.youtube.com/results?search_query=veg+khichdi+recipe+south+indian", 
                tags: ["dal", "rice", "khichdi", "one-pot", "vegetarian"],
                ingredients: ["Rice (Free, controlled portion)", "**200g Dal**", "**Mixed Root/Leafy Vegetables**", "Spices"],
                method: [
                    "Wash rice and dal.",
                    "In a pressure cooker, add minimal oil/ghee, spices, and veggies (if using).",
                    "Add rice, dal, water (3x quantity), and salt.",
                    "Cook for 3-4 whistles until soft and well-combined."
                ]
            },
            {
                id: 6,
                title: "Egg Bhurji & Roti (3 Eggs)",
                focus: "Simple, quick, and high-protein alternative breakfast or dinner.",
                mealType: "Breakfast/Dinner",
                calories: 450, 
                protein: 25, 
                tutorialUrl: "https://www.youtube.com/results?search_query=egg+bhurji+roti+recipe+low+oil", 
                tags: ["egg", "bhurji", "roti", "high protein", "indian"],
                ingredients: ["**3 Eggs**", "Atta for 3 Rotis (Free)", "Onion, Green Chili", "Minimal Oil/Ghee, Spices"],
                method: [
                    "Heat minimal oil/ghee, saut√© chopped onion and chili until translucent.",
                    "Add spices (turmeric, chili powder).",
                    "Whisk eggs and pour into the pan. Scramble until cooked through.",
                    "Serve hot with rotis."
                ]
            },
            {
                id: 7,
                title: "High-Protein Egg White Omelette with Greens",
                focus: "Minimal fat, highest quality protein breakfast. Uses 4 Egg Whites + 1 Whole Egg and Greens.",
                mealType: "Breakfast",
                calories: 230, 
                protein: 22, 
                tutorialUrl: "https://www.youtube.com/results?search_query=high+protein+egg+white+omelette+with+spinach+south+indian", 
                tags: ["egg", "breakfast", "low carb", "high protein", "leafy green"],
                ingredients: ["**4 Egg Whites + 1 Whole Egg**", "**Chopped Spinach/Cabbage**", "Onion/Tomato/Capsicum (Budget Veg)", "Minimal Oil/Ghee", "Spices"],
                method: [
                    "Whisk egg whites and whole egg with salt and pepper.",
                    "Heat a non-stick pan with minimal oil, saut√© chopped vegetables and greens.",
                    "Pour the egg mixture over the vegetables. Cook until firm. Fold and serve hot."
                ]
            },
            {
                id: 8,
                title: "High-Fiber Black Chana Veg Curry (Large)",
                focus: "Maximum fiber and protein from whole legumes and added vegetables. Great dinner option.",
                mealType: "Lunch/Dinner",
                calories: 450, 
                protein: 30, 
                tutorialUrl: "https://www.youtube.com/results?search_query=kala+chana+masala+with+vegetables+weight+loss+south+indian", 
                tags: ["dal", "chana", "curry", "lunch", "fiber", "vegetable"],
                ingredients: ["**150g Black Chana (Kala Chana)**", "**Mixed Vegetables (Gourd/Carrot)**", "Onion/Tomato (Budget Veg)", "Ginger-Garlic Paste", "Spices", "Minimal Oil/Ghee"],
                method: [
                    "Soak Chana overnight, then boil until soft.",
                    "Prepare a light curry base using saut√©ed onion, tomato, and spices.",
                    "Add the boiled Chana and **chopped vegetables** and simmer.",
                    "Serve with rotis or rice."
                ]
            },
            {
                id: 9,
                title: "Baked High-Protein Soya Cutlets (4 pcs)",
                focus: "Zero-oil snack or side dish. High satiety.",
                mealType: "Snack/Side",
                calories: 350, 
                protein: 30, 
                tutorialUrl: "https://www.youtube.com/results?search_query=baked+soya+cutlet+recipe+zero+oil", 
                tags: ["soya", "snack", "zero oil", "low carb", "cutlet"],
                ingredients: ["**75g Soya Chunks (dry)**", "1 small boiled Potato (Binder)", "Coriander, Green Chili", "Spices"],
                method: [
                    "Boil Soya chunks, squeeze water, and blend/mash roughly.",
                    "Mash boiled potato and mix with Soya, coriander, chili, and spices.",
                    "Form into small patties (4 cutlets).",
                    "Bake/Air-Fry until crisp (preferred) or shallow-fry with minimal oil."
                ]
            },
            {
                id: 10,
                title: "High-Fiber Soya & Leafy Greens Curry",
                focus: "Maximum fiber and protein in a low-fat, budget-friendly curry base.",
                mealType: "Dinner",
                calories: 500, 
                protein: 40, 
                tutorialUrl: "https://www.youtube.com/results?search_query=soya+chunks+spinach+curry+south+indian", 
                tags: ["soya", "leafy green", "dinner", "high protein", "curry", "fiber", "low fat"],
                ingredients: ["**100g Soya Chunks (dry)**", "**200g Leafy Greens (Spinach/Methi)**", "Onion/Tomato/Ginger-Garlic Paste", "Spices", "Minimal Oil/Ghee"],
                method: [
                    "Soak Soya Chunks, squeeze water.",
                    "Prepare a light curry base (use water/dry roast for flavor).",
                    "Add the Soya Chunks and spices.",
                    "Stir in the **chopped leafy greens** and cook until wilted and tender. Serve with 3 Rotis."
                ]
            }
        ];

        const recipeListEl = document.getElementById('recipe-list');
        const noResultsEl = document.getElementById('no-results');

        /**
         * Renders the list of provided recipes into the HTML container.
         * @param {Array} recipesToRender - The array of recipe objects to display.
         */
        function renderRecipes(recipesToRender) {
            recipeListEl.innerHTML = ''; // Clear existing content

            if (recipesToRender.length === 0) {
                noResultsEl.classList.remove('hidden');
                return;
            }

            noResultsEl.classList.add('hidden');

            recipesToRender.forEach(recipe => {
                // Ensure bolding for key ingredients
                const ingredientsList = recipe.ingredients.map(ing => `<li class="text-sm text-gray-600 ml-4">${ing}</li>`).join('');
                const methodList = recipe.method.map(step => `<li class="text-sm text-gray-600 ml-4">${step}</li>`).join('');
                
                // Nutrition Badges
                const nutritionBadges = `
                    <div class="flex space-x-3 mb-3">
                        <span class="inline-flex items-center px-3 py-1 text-sm font-medium rounded-full kcal-badge">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            ${recipe.calories} kcal
                        </span>
                        <span class="inline-flex items-center px-3 py-1 text-sm font-medium rounded-full protein-badge">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            ${recipe.protein}g Protein
                        </span>
                    </div>
                `;

                // Tutorial Button
                const tutorialButton = recipe.tutorialUrl ? `
                    <a href="${recipe.tutorialUrl}" target="_blank" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                        Watch Video Tutorial
                    </a>
                ` : '';


                // Create the HTML card for the recipe
                const recipeCard = `
                    <div class="recipe-card p-6 rounded-xl shadow-lg border-t-4 border-blue-500 flex flex-col justify-between">
                        <div>
                            <span class="inline-block px-2.5 py-0.5 text-xs font-semibold rounded-full focus-badge mb-3">${recipe.mealType.toUpperCase()}</span>
                            ${nutritionBadges} 
                            <h3 class="text-xl font-bold text-gray-800 mb-2">${recipe.title}</h3>
                            <p class="text-sm text-gray-500 mb-4">${recipe.focus}</p>

                            <div class="space-y-4">
                                <div>
                                    <h4 class="font-semibold text-gray-700 mb-1 flex items-center"><svg class="w-4 h-4 mr-1 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944v.001zm0 14.111a11.955 11.955 0 01-8.618-4.016l-.772.772A11.963 11.963 0 0012 20.944v.001zm0-14.111a11.955 11.955 0 008.618 4.016l.772-.772A11.963 11.963 0 0112 2.944v.001z"></path></svg> Ingredients:</h4>
                                    <ul class="list-disc list-inside space-y-1">
                                        ${ingredientsList}
                                    </ul>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-700 mt-3 mb-1 flex items-center"><svg class="w-4 h-4 mr-1 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg> Method:</h4>
                                    <ol class="list-decimal list-inside space-y-1">
                                        ${methodList}
                                    </ol>
                                </div>
                            </div>
                        </div>
                        ${tutorialButton}
                    </div>
                `;
                recipeListEl.insertAdjacentHTML('beforeend', recipeCard);
            });
        }

        /**
         * Filters the allRecipes array based on the search input value.
         */
        function filterRecipes() {
            const searchTerm = document.getElementById('recipe-search').value.toLowerCase().trim();

            if (!searchTerm) {
                renderRecipes(allRecipes);
                return;
            }

            const filtered = allRecipes.filter(recipe => {
                // Check title, mealType, focus, and tags
                const recipeText = `${recipe.title} ${recipe.mealType} ${recipe.focus} ${recipe.tags.join(' ')}`.toLowerCase();
                return recipeText.includes(searchTerm);
            });

            renderRecipes(filtered);
        }

        // --- IMAGE ANALYSIS LOGIC ---

        document.getElementById('meal-image-input').addEventListener('change', handleImageUpload);

        /**
         * Converts a File object to a base64 encoded string.
         * @param {File} file - The file to convert.
         * @returns {Promise<string>} Base64 data string (e.g., "data:image/jpeg;base64,...").
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        // Exponential backoff retry utility
        const retryFetch = async (url, options, retries = 3) => {
            let error;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (e) {
                    error = e;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            throw error;
        };

        /**
         * Handles the image upload and calls the Gemini Vision API for analysis.
         */
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            const loadingEl = document.getElementById('loading-indicator');
            const resultEl = document.getElementById('analysis-result');
            const outputEl = document.getElementById('analysis-output');
            const errorEl = document.getElementById('analysis-error');

            resultEl.classList.add('hidden');
            errorEl.classList.add('hidden');
            outputEl.textContent = '';
            
            if (!file) return;

            loadingEl.classList.remove('hidden');

            try {
                // 1. Convert image to base64
                const base64Url = await fileToBase64(file);
                const [mimeType, base64Data] = base64Url.split(';base64,');
                
                // 2. Construct the API payload
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                const prompt = "Analyze the attached South Indian meal. Estimate the total calories (kcal) and total protein (grams) in the meal. Given the user's high protein goal, assume portions are large. Provide the response as a clear, formatted text block, listing the estimated ingredients and then the estimations. Do not include any introductory or concluding sentences.";

                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: prompt },
                                {
                                    inlineData: {
                                        mimeType: mimeType.replace('data:', ''),
                                        data: base64Data
                                    }
                                }
                            ]
                        }
                    ],
                    systemInstruction: {
                        parts: [{ text: "You are an AI nutritionist focused on South Indian cuisine. Your task is to provide estimated macronutrient content for the pictured food. Be concise and focus on calories and protein, recognizing that the user is aiming for a 185g protein target daily." }]
                    }
                };

                // 3. Call the Gemini API
                const response = await retryFetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    outputEl.textContent = generatedText;
                    resultEl.classList.remove('hidden');
                } else {
                    errorEl.textContent = "Analysis failed: Could not parse AI response.";
                    errorEl.classList.remove('hidden');
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                errorEl.textContent = `Analysis failed: ${error.message}. Please check console for details.`;
                errorEl.classList.remove('hidden');
            } finally {
                loadingEl.classList.add('hidden');
            }
        }

        // Initial render when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            filterRecipes();
        });
    </script>
</body>
</html>
